#ifndef SMALLNTT_H
#define SMALLNTT_H

#include <stdint.h>
#include "params.h"

#define SMALL_Q 769 //3329 or 769
#define MULTI_MODULI

static const int32_t zetas_769[64] = {
	3138844760, 1334846793, 999738812, 1854264165, 1681125041, 1150537404, 2820492178, 3071823164, 726067294, 2066499220, 3272887953, 1055590142, 4255871365, 1871019564, 2731130050, 1826338500, 513832239, 1792827701, 3373420347, 2993631302, 1161707670, 3306398751, 3518633806, 3406931146, 1586177780, 3853741788, 3317569017, 3825816122, 971813147, 122872927, 217820188, 619949766, 3753209393, 770748358, 4099487641, 765163225, 3630336467, 1742561504, 3479537875, 982983413, 2809321912, 2379266669, 703726762, 681386230, 4110657907, 1457719720, 1217559000, 2474213930, 1195218468, 1089100940, 564098436, 614364633, 3635921600, 2088839752, 3702943196, 1949211426, 2569161192, 374203913, 3982199847, 2083254619, 1513571050, 3647091866, 413299844, 4149753838};

static const int32_t zetas_asm_769[128] = {
	346278248, 223405321, 966228013, 759578091, -150798592, 318352582, -1736976371, 1697880440, 474736307, -631120032, -1200803600, -1435379187, -787503756, -1580592646, -2105595150, 1809583100, 525002504, -100532394, -1938041160, 273671518, -212235055, -804259156, 139628326, 67021596, 27925665, 1731391238, 1117026605, 536172770, 1675539907, 1290165729, -1614103444, -497076839, -753992958, 1591762912, -94947261, -1016494210, -1709050706, 1413038655, 1010909077, -1748146637, 1781657435, -1206388733, 1401868389, 357448514, 686971362, 44681064, -1524741316, 1787242568, -860110486, -2005062756, -502661972, -1100271206, -1921285760, 1139367137, 457980908, -1669954774, 240160720, 1368357591, -1061175275, 698141628, 335107981, -2139105948, 519417371, -1156122536, 1334846793, 999738811, 1854264164, 1681125040, 1150537403, -1474475119, -1223144132, 726067293, 2066499219, -1022079344, 1055590142, -39095931, 1871019563, -1563837247, 1826338499, 513832238, 1792827701, -921546949, -1301335995, 1161707669, -988568545, -776333490, -888036151, 1586177779, -441225509, -977398279, -469151174, 971813146, 122872927, 217820188, 619949766, -541757903, 770748357, -195479656, 765163224, -664630830, 1742561504, -815429422, 982983412, -1485645385, -1915700627, 703726761, 681386229, -184309390, 1457719719, 1217558999, -1820753366, 1195218467, 1089100940, 564098435, 614364633, -659045697, 2088839751, -592024101, 1949211426, -1725806105, 374203913, -312767449, 2083254618, 1513571050, -647875431, 413299844, -145213459, 0};

// INTT with CT butterfly
static const int32_t zetas_inv_asm_769[256] = {
	5585134, 5585134, -346278248, 5585134, -966228013, -346278248, -223405321, 5585134, 1736976371, -966228013, 150798592, -346278248, -318352582, -223405321, -759578091, 5585134, -346278248, 5585134, -966228013, -346278248, -223405321, 636705165, 446810642, 1519156183, 11170266, -821014555, -1932456027, 301597183, -692556495, -240160720, 1061175275, -1368357591, -519417371, -335107981, 2139105948, -698141628, -625534899, -1267825197, 843355087, 290426917, 128458060, 1295750862, -748407825, -826599688, 1736976371, -240160720, 2005062756, 1061175275, 1100271206, -1368357591, 502661972, 915961816, 1396283256, 452395775, -1038834743, -955057747, -670215963, 2016233022, -16755399, -1675539907, 1614103444, -1290165729, 94947261, 753992958, -1591762912, 497076839, -1954796559, 1943626293, -1122611738, -1239899531, 938302348, -245745853, 882451018, -435640376, -966228013, 1736976371, -318352582, -240160720, -1401868389, 2005062756, 1016494210, 714897027, -1005323944, 876865885, 2122350549, -1373942724, -2094424884, 1468889985, 1558252114, -1401868389, -686971362, -357448514, 860110486, 1524741316, -1787242568, -44681064, 1407453522, -368618780, 1323676527, -653460564, -1362772458, 1379527857, -463566041, 1859849297, 150798592, -1675539907, 804259156, 1614103444, -67021596, -1290165729, -139628326, -2060914086, -994153678, 55851330, 189894523, -1072345541, 1507985917, 832184821, 1111441472, 2105595150, -525002504, -1809583100, 212235055, 1938041160, -273671518, 100532394, -2044158687, -78191862, 1452134586, 642290298, -2111180283, 552928169, 161968858, -1167292802, -346278248, -966228013, -223405321, 1736976371, 150798592, -318352582, -759578091, -1608518311, -2032988421, -899206417, -480321440, 943887481, 1491230518, -83776995, -284841784, 2005062756, 1100271206, 502661972, 1669954774, -1139367137, -457980908, 1921285760, 1128196871, -1318091394, -1904530361, 396544445, -1228729265, 117287794, 2116765416, 1184048201, -318352582, -1401868389, 1016494210, -686971362, -1413038655, -357448514, 1709050706, -731652426, 89362128, 2021818155, 1720220972, -1882189829, -1245484665, -798674023, 720482160, 804259156, -67021596, -139628326, -536172770, -1731391238, -1117026605, -27925665, -1843093898, -1971551958, 1027664477, 1776072302, -1692295306, 1977137091, 709311894, 1552666981, -223405321, 150798592, -759578091, -1675539907, 2105595150, 804259156, -1697880440, -675801096, 279256651, 949472614, -1066760408, -1050005009, -134043193, 1262240064, 1714635839, 1016494210, -1413038655, 1709050706, 1206388733, 1748146637, -1781657435, -1010909077, -390959312, -1329261660, -1083515807, -1965966825, -1530326449, 809844289, -1541496715, 1630858843, -759578091, 2105595150, -1697880440, -525002504, 631120032, -1809583100, -474736307, -1575007513, -201064789, 1893360095, 424470110, -1133782004, -418884977, -1424208921, -547343036, -1697880440, 631120032, -474736307, 1580592646, 1435379187, 787503756, 1200803600, 1999477623, -932717215, 1982722224, -1848679031, 586438968, 1993892490, 1625273710, -1346017059, 0};

// Q1=769
void small_ntt_asm_769(int16_t a[N], const int32_t *zetas);
void small_invntt_asm_769(int16_t a[N], const int32_t *zetas);
void small_pointmul_asm_769(int16_t out[N], const int16_t in[N], const int32_t *zetas);
void small_asymmetric_mul_asm_769(int16_t c[N], const int16_t a[N], const int16_t b[N], const int16_t b_prime[N]);

// small NTT for computing cs0 and cs1; default use 769 as modulus.
#define small_ntt(a) small_ntt_asm_769(a, zetas_asm_769)
#define small_invntt_tomont(a) small_invntt_asm_769(a, zetas_inv_asm_769)
#define small_point_mul(out, in) small_pointmul_asm_769(out, in, zetas_769)
#define small_asymmetric_mul(c, a, b, b_prime) small_asymmetric_mul_asm_769(c, a, b, b_prime);

// Multi-moduli for computing ct0 and ct1; 769 as q0, 3329 as q1.
#ifdef MULTI_MODULI
static const int32_t zetas_3329[64] = {
	21932846, 3562152210, 752167598, 3417653460, 2112004045, 932791035, 2951903026, 1419184148, 1817845876, 3434425636, 4233039261, 300609006, 975366560, 2781600929, 3889854731, 3935010590, 2197155094, 2130066389, 3598276897, 2308109491, 2382939200, 1228239371, 1884934581, 3466679822, 1211467195, 2977706375, 3144137970, 3080919767, 945692709, 3015121229, 345764865, 826997308, 2043625172, 2964804700, 2628071007, 4154339049, 483812778, 3288636719, 2696449880, 2122325384, 1371447954, 411563403, 3577634219, 976656727, 2708061387, 723783916, 3181552825, 3346694253, 3617629408, 1408862808, 519937465, 1323711759, 1474661346, 2773859924, 3580214553, 1143088323, 2221668274, 1563682897, 2417773720, 1327582262, 2722253228, 3786641338, 1141798155, 2779020594};

static const int32_t zetas_asm_3329[128] = {
	-2064267850, -966335387, -51606696, -886345008, 812805466, -1847519726, 1094061961, 1370157786, 381889552, -1137927652, 372858380, 427045412, -98052723, -2029433330, -1819136043, 1727534157, 1904287092, 1544330385, -1322421592, -1357256112, -1643673276, 249002309, -365117376, 72249375, 838608814, -1744306333, -1052776604, 815385801, 1028263423, -1404992306, 1719793153, -598637677, 42575524, 1703020976, -1824296713, -700560902, 1839778722, -1593356747, -1303069080, 1851390228, 1041165097, 583155668, -89021551, 690239562, -576704831, 1855260730, -594767174, 1979116801, -1195985186, 734105254, -1207596692, -580575333, -879894171, -918599193, 1910737929, 836028479, -2042335004, -1748176836, 1059227441, -1103093132, -282546662, 1583035408, 1174052340, 21932846, -732815087, 752167598, -877313836, 2112004044, 932791035, -1343064270, 1419184147, 1817845876, -860541660, -61928036, 300609006, 975366559, -1513366368, -405112566, -359956706, -2097812203, 2130066388, -696690399, -1986857806, -1912028096, 1228239371, 1884934581, -828287475, 1211467195, -1317260922, -1150829327, -1214047529, 945692709, -1279846067, 345764865, 826997308, 2043625172, -1330162596, -1666896289, -140628247, 483812777, -1006330577, -1598517417, 2122325384, 1371447953, 411563403, -717333078, 976656727, -1586905910, 723783915, -1113414472, -948273044, -677337888, 1408862808, 519937465, 1323711759, 1474661346, -1521107372, -714752743, 1143088322, -2073299022, 1563682897, -1877193576, 1327582261, -1572714068, -508325958, 1141798155, -1515946703, 0};

// INTT with CT butterfly
static const int32_t zetas_inv_asm_3329[256] = {
	1290168, 1290168, 2064267850, 1290168, 51606696, 2064267850, 966335387, 1290168, -1094061961, 51606696, -812805466, 2064267850, 1847519726, 966335387, 886345008, 
	// remove the first constant
	1290168, 2064267850, 1290168, 51606696, 2064267850, 966335387, -1859131233, 290287666, -1350805275, -1273395230, 1802363867, 603798346, -919889361, -1617869928, 2042335004, -1059227441, 1748176836, -1174052340, 282546662, -1583035408, 1103093132, 1659155285, 1785591690, 1941701947, -1590776412, 358666539, 793452955, 1461759671, 1673347126, -1094061961, 2042335004, -734105254, -1059227441, 580575333, 1748176836, 1207596692, -407692900, 2126195886, 872153167, -851510488, 526388302, 299318838, -419304407, -912148356, -1028263423, -1719793153, 1404992306, 1824296713, -42575524, -1703020976, 598637677, 1997179145, -1390800464, -1717212818, 202556283, 30964018, -487683280, 1238560710, 1967505295, 51606696, -1094061961, 1847519726, 2042335004, 89021551, -734105254, 700560902, 1633351937, -2102972872, 909568022, 1780431021, 2022982493, -1797203197, -685078893, 1126316146, 89021551, 576704831, -690239562, 1195985186, 594767174, -1979116801, -1855260730, -661855879, -1386929962, -704431404, 357376372, 1887514916, 1410152975, -1808814704, 571544161, -812805466, -1028263423, -249002309, -1719793153, -72249375, 1404992306, 365117376, -291577834, -1850100061, 1221788534, -989558401, 1626901100, -927630365, 651534540, 1549491055, 1819136043, -1904287092, -1727534157, 1643673276, 1322421592, 1357256112, -1544330385, 993428903, -614119685, 1082450454, 1205016358, 348345200, 956014048, 1048906101, -414143737, 2064267850, 51606696, 966335387, -1094061961, -812805466, 1847519726, 886345008, -952143546, -36124687, 568963826, -1444987495, 1283716569, -1964924960, -190944776, -1287587072, -734105254, 580575333, 1207596692, -836028479, 918599193, -1910737929, 879894171, -2077169524, 503165289, -1482402350, -1348224940, 833448145, 1905577259, -1021812586, -1086320956, 1847519726, 89021551, 700560902, 576704831, 1593356747, -690239562, -1839778722, -1132766983, -1486272852, 1933960942, 678628056, 49026361, 1375318455, 1961054458, -821836638, -249002309, -72249375, 365117376, -815385801, 1744306333, 1052776604, -838608814, 438656918, 1681088131, 366407543, -1475951513, 1771399849, 1091481626, 2136517225, 709592074, 966335387, -812805466, 886345008, -1028263423, 1819136043, -249002309, -1370157786, 25803348, -406402733, 1032133925, 923759863, -1664315954, -1704311144, 2146838564, 547030980, 700560902, 1593356747, -1839778722, -583155668, -1851390228, -1041165097, 1303069080, 254162979, -781841448, 1576584571, -1208886860, -1361126614, -1110834137, 1389510297, -1483692517, 886345008, 1819136043, -1370157786, -1904287092, 1137927652, -1727534157, -381889552, -2006210317, 459299597, 1355965944, 1192114684, -1595937082, 439947086, 587026170, 418014240, -1370157786, 1137927652, -381889552, 2029433330, -427045412, 98052723, -372858380, 639923034, -1488853187, -172882432, 575414663, 1674637294, 1541750051, -1733984994, 1540459883,  0};

void small_ntt_asm_3329(int16_t a[N], const int32_t *zetas);
void small_invntt_asm_3329(int16_t a[N], const int32_t *zetas);
void small_pointmul_asm_3329(int16_t out[N], const int16_t in[N], const int32_t *zetas);
void small_asymmetric_mul_asm_3329(int16_t c[N], const int16_t a[N], const int16_t b[N], const int16_t b_prime[N]);

void __asm_small_CRT_32(int32_t c[N], const int16_t a[N],const int16_t b[N]);

// double-moduli NTT for computing ct0 and ct1
#define double_ntt(in)                              \
	{                                               \
		small_ntt_asm_769(in, zetas_asm_769);       \
		small_ntt_asm_3329(in + N, zetas_asm_3329); \
	}
#define double_invntt(in)                                  \
	{                                                      \
		small_invntt_asm_769(in, zetas_inv_asm_769);       \
		small_invntt_asm_3329(in + N, zetas_inv_asm_3329); \
	}
#define double_point_mul(out, in)                             \
	{                                                         \
		small_pointmul_asm_769(out, in, zetas_769);           \
		small_pointmul_asm_3329(out + N, in + N, zetas_3329); \
	}
#define double_asymmetric_mul(out, in1, in2, in2_prime)                          \
	{                                                                            \
		small_asymmetric_mul_asm_769(out, in1, in2, in2_prime);                  \
		small_asymmetric_mul_asm_3329(out + N, in1 + N, in2 + N, in2_prime + N); \
	}
#define double_CRT(out, in1, in2)          \
	{                                      \
		__asm_small_CRT_32(out, in1, in2); \
	}

#endif

#endif
